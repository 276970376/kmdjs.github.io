<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Alloy Render Engine</title>
</head>
<body>   
     
    <div style="text-align:center;"><canvas width="320" id="ourCanvas" height="480" style="border:1px solid #ccc;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></canvas> </div>
 <div  style="text-align:center;">

     <select id="rdSlt">
         <option value="0">WebGL渲染</option>
         <option value="1">Canvas渲染</option>
     </select>
 </div>

    <script>
        var rdSlt = document.getElementById("rdSlt");
        var webglSupport = (function () { try { var canvas = document.createElement('canvas'); return !!(window.WebGLRenderingContext && (canvas.getContext('webgl') || canvas.getContext('experimental-webgl'))); } catch (e) { return false; } })();
        if (!webglSupport) { rdSlt.selectedIndex = 1; }
        if (localStorage.webgl) {
            if (localStorage.webgl == "0") {
                rdSlt.selectedIndex = 0;
            } else {
                rdSlt.selectedIndex = 1;
            }
        }
        rdSlt.onchange = function () {
            var index = rdSlt.selectedIndex; // 选中索引
            var value = rdSlt.options[index].value; // 选中值

            localStorage.webgl = value;

            location.reload();
        }
        !function () {
            var e = !1, n = /xyz/.test(function () { }) ? /\b_super\b/ : /.*/, i = function () { }; i.extend = function (t) { function i() { !e && this.ctor && this.ctor.apply(this, arguments) } var a, s, o, r = this.prototype; e = !0, a = new this, e = !1; for (o in t) "statics" != o && (a[o] = "function" == typeof t[o] && "function" == typeof r[o] && n.test(t[o]) ? function (t, e) { return function () { var i, n = this._super; return this._super = r[t], i = e.apply(this, arguments), this._super = n, i } }(o, t[o]) : t[o]); for (s in this) this.hasOwnProperty(s) && "extend" != s && (i[s] = this[s]); if (i.prototype = a, t.statics) for (o in t.statics) t.statics.hasOwnProperty(o) && (i[o] = t.statics[o], "ctor" == o && i[o]()); return i.prototype.constructor = i, i.extend = arguments.callee, i.implement = function (t) { for (var e in t) a[e] = t[e] }, i }, function () {
                var t = {}, e = {}; t.DisplayObject = i.extend({ ctor: function () { this.alpha = this.scaleX = this.scaleY = 1, this.x = this.y = this.rotation = this.originX = this.originY = this.skewX = this.skewY = this.width = this.height = this.regX = this.regY = 0, this.flipX = this.flipY = !1, this.visible = !0, this._matrix = new t.Matrix2D, this.events = {}, this.id = t.UID.get(), this.cacheID = 0, this.inner = !0, this.baseInstanceof = "DisplayObject"; var e = this; this._watch(this, "originX", function (t, n) { e.regX = e.width * n }), this._watch(this, "originY", function (t, n) { e.regY = e.height * n }); var e = this; this._watch(this, "filter", function (t, n) { e.setFilter.apply(e, n) }) }, _watch: function (t, e, n) { t["__" + e] = this[e]; Object.defineProperty(t, e, { get: function () { return this["__" + e] }, set: function (t) { this["__" + e] = t, n(e, t) } }) }, isVisible: function () { return !!(this.visible && this.alpha > 0 && 0 != this.scaleX && 0 != this.scaleY && this.inner) }, on: function (t, e) { this.events[t] || (this.events[t] = []), this.events[t].push(e) }, execEvent: function (t) { var e = this.events[t]; this._fireFns(e) }, hover: function (t, e) { this.on("mouseover", t), this.on("mouseout", e) }, _fireFns: function (t) { if (t) for (var e = 0, n = t.length; n > e; e++) t[e].call(this) }, clone: function () { var e = new t.DisplayObject; return this.cloneProps(e), e }, cloneProps: function (t) { t.visible = this.visible, t.alpha = this.alpha, t.originX = this.originX, t.originY = this.originY, t.rotation = this.rotation, t.scaleX = this.scaleX, t.scaleY = this.scaleY, t.skewX = this.skewX, t.skewY = this.skewY, t.x = this.x, t.y = this.y, t.regX = this.regX, t.regY = this.regY }, cache: function () { if (!this.cacheCanvas) { this.cacheCanvas = document.createElement("canvas"); var e = this.getBound(); this.cacheCanvas.width = e.width, this.cacheCanvas.height = e.height, this.cacheCtx = this.cacheCanvas.getContext("2d") } this.cacheID = t.UID.getCacheID(), t.Stage.renderer.updateCache(this.cacheCtx, this, e.width, e.width) }, uncache: function () { this.cacheCanvas = null, this.cacheCtx = null, this.cacheID = null }, setFilter: function (t, e, n, i) { if (0 !== this.width && 0 !== this.height) { this.uncache(), this.cache(); for (var r = this.cacheCtx.getImageData(0, 0, this.cacheCanvas.width, this.cacheCanvas.height), a = r.data, s = 0, o = a.length; o > s; s += 4) a[s + 3] > 0 && (a[s] *= t, a[s + 1] *= e, a[s + 2] *= n, a[s + 3] *= i); this.cacheCtx.putImageData(r, 0, 0) } }, getBound: function () { return { width: this.width, height: this.height } }, toCenter: function () { this.originX = .5, this.originY = .5, this.x = this.parent.width / 2, this.y = this.parent.height / 2 }, onClick: function (t) { this.on("click", t) }, onMouseMove: function (t) { this.on("mousemove", t) }, destroy: function () { this.cacheCanvas = null, this.cacheCtx = null, this.cacheID = null, this._matrix = null, this.events = null, this.parent && this.parent.remove(this) }, getAABB: function () { if (0 === this.rotation) { var e = this.width * this.scaleX, n = this.height * this.scaleY, i = [this.x - e * this.originX, this.y - n * this.originY, e, n]; return this.parent instanceof t.Container ? this.parent.superimposeAABB(i) : i } }, superimposeAABB: function (e) { if (0 === this.rotation) { var n = e[2] * this.scaleX, i = e[3] * this.scaleY, r = [this.x + e[0] - e[0] * (1 - this.scaleX), this.y + e[1] - e[1] * (1 - this.scaleY), n, i]; return this.parent instanceof t.Container ? this.parent.superimposeAABB(r) : r } }, getTransformedAABB: function () { } }), t.Container = t.DisplayObject.extend({ ctor: function () { this._super(), this.children = [], this.baseInstanceof = "Container" }, add: function (t) { var e = arguments.length; if (e > 1) for (var n = 0; e > n; n++) { var i = arguments[n]; i && (this.children.push(i), i.parent = this) } else t && (this.children.push(t), t.parent = this) }, remove: function (t) { var e = arguments.length, n = this.children.length; if (e > 1) { for (var i = 0; e > i; i++) for (var r = arguments[i], a = n; --a >= 0;) if (this.children[a].id == r.id) { r.parent = null, this.children.splice(a, 1); break } } else for (var s = n; --s >= 0;) if (this.children[s].id == t.id) { t.parent = null, this.children.splice(s, 1); break } }, clone: function () { var e = new t.Container; this.cloneProps(e); for (var n = e.children = [], i = this.children.length - 1; i > -1; i--) { var r = this.children[i].clone(); n.unshift(r) } return e }, removeAll: function () { for (var t = this.children; t.length;) t.pop().parent = null }, destroy: function () { this._super(); for (var t = this.children; t.length;) { var e = t.pop(); e.destroy() } } }), e.Main = i.extend({ ctor: function () { var e = new t.Loader, i = new t.Stage("#ourCanvas", "1" == localStorage.webgl); i.debug = !0, e.loadRes([{ id: "hero", src: "hero-m.png" }]), e.complete(function () { for (var n = 0; 200 > n; n++) { var r = new t.Sprite({ x: 260 * Math.random(), y: 380 * Math.random(), framerate: 5, imgs: [e.get("hero")], frames: [[64, 64, 64, 64], [128, 64, 64, 64], [192, 64, 64, 64], [256, 64, 64, 64], [320, 64, 64, 64], [384, 64, 64, 64], [448, 64, 64, 64], [0, 192, 64, 64], [64, 192, 64, 64], [128, 192, 64, 64], [192, 192, 64, 64], [256, 192, 64, 64], [320, 192, 64, 64], [384, 192, 64, 64], [448, 192, 64, 64], [448, 192, 64, 64]], animations: { walk: { frames: [0, 1, 2, 3, 4, 5, 6], next: "run", speed: 2, loop: !1 }, happy: { frames: [11, 12, 13, 14] }, win: { frames: [7, 8, 9, 10] } }, currentAnimation: "walk" }); i.add(r) } }) } }), t.Stage = t.Container.extend({ ctor: function (e, n) { this._super(), this.canvas = "string" == typeof e ? document.querySelector(e) : e, this.width = this.canvas.width, this.height = this.canvas.height, this.AABB = [0, 0, this.width, this.height]; var r = (!!window.CanvasRenderingContext2D, function () { try { var t = document.createElement("canvas"); return !(!window.WebGLRenderingContext || !t.getContext("webgl") && !t.getContext("experimental-webgl")) } catch (e) { return !1 } }()); r && !n ? this.renderer = new t.WebGLRenderer(this) : (this.ctx = this.canvas.getContext("2d"), this.renderer = new t.CanvasRenderer(this)), t.Stage.renderer = this.renderer, this.hitRenderer = new t.CanvasRenderer(this), this.hitCanvas = document.createElement("canvas"), this.hitCanvas.width = 1, this.hitCanvas.height = 1, this.hitCtx = this.hitCanvas.getContext("2d"), Function.prototype.bind = function () { var t = this, e = Array.prototype.slice.call(arguments), n = e.shift(); return function () { return t.apply(n, e.concat(Array.prototype.slice.call(arguments))) } }, this._scaleX = this._scaleY = null, this.offset = this._getXY(this.canvas), this.overObj = null, this.pause = !1, this.fps = 63, this.interval = Math.floor(1e3 / this.fps); var a = this; a.loop = setInterval(function () { a._tick(a) }, a.interval), Object.defineProperty(this, "useRequestAnimFrame", { set: function (e) { this._useRequestAnimFrame = e, e ? (clearInterval(a.loop), a.loop = t.RAF.requestInterval(function () { a._tick(a) }, a.interval)) : (t.RAF.clearRequestInterval(a.loop), a.loop = setInterval(function () { a._tick(a) }, a.interval)) }, get: function () { return this._useRequestAnimFrame } }), this.domSurface = document.createElement("div"); var s = this.domSurface.style; s.width = this.width + "px", s.height = this.height + "px", s.backgroundColor = "rgba(255,255,255,0)", s.zIndex = 1003, s.position = "absolute", s.border = "0px solid red", s.left = this.offset[0] + "px", s.top = this.offset[1] + "px", document.body.appendChild(this.domSurface), this.domSurface.addEventListener("mousemove", this._handleMouseMove.bind(this), !1), this.domSurface.addEventListener("click", this._handleClick.bind(this), !1), this.innerObjectCount = 0, this.debugDiv = document.createElement("div"), this.debugDiv.style.cssText = "display:none;position:absolute;z-index:1000;left:0;top:0;background-color:yellow;font-size:20px;", document.body.appendChild(this.debugDiv), Object.defineProperty(this, "debug", { set: function (t) { this._debug = t, this.debugDiv.style.display = this._debug ? "block" : "none" }, get: function () { return this._debug } }) }, add: function (e) { this._super.apply(this, arguments); var n, i = arguments.length; for (n = 0; i > n; n++) { var e = arguments[n]; e instanceof t.DomElement && this.domSurface.appendChild(e.element) } }, update: function () { this.pause || (this.hideOuterObject(this), this.renderer.update()) }, _handleClick: function (t) { if (t.stageX = t.pageX - this.offset[0], t.stageY = t.pageY - this.offset[1], this._scaleX) { var e = this.correctingXY(t.stageX, t.stageY); t.stageX = Math.round(e.x), t.stageY = Math.round(e.y) } var n = this.events.click; if (n) for (var i = 0, r = n.length; r > i; i++) { var a = n[i]; a(t) } this.hitRenderer.hitRender(this.hitCtx, this, null, t.stageX, t.stageY, "click") }, _handleMouseMove: function (t) { if (t.stageX = t.pageX - this.offset[0], t.stageY = t.pageY - this.offset[1], this._scaleX) { var e = this.correctingXY(t.stageX, t.stageY); t.stageX = Math.round(e.x), t.stageY = Math.round(e.y) } var n = this.events.mousemove; if (n) for (var i = 0, r = n.length; r > i; i++) { var a = n[i]; a(t) } }, _getXY: function (t) { var e = 0, n = 0; if (!document.documentElement.getBoundingClientRect || !t.getBoundingClientRect) { for (; t.offsetParent;) e += t.offsetTop, n += t.offsetLeft, t = t.offsetParent; return [n, e] } var i = t.getBoundingClientRect(); return n = i.left, e = i.top, [n + Math.max(document.documentElement.scrollLeft, document.body.scrollLeft), e + Math.max(document.documentElement.scrollTop, document.body.scrollTop)] }, destroy: function () { }, _tick: function (t) { if (t && t.tick) if (this._initInterval(t), t.hasOwnProperty("_tickInterval")) { t._tickIntervalCurrent = new Date, t._tickIntervalLast || (t._tickIntervalLast = new Date); var e = t._tickIntervalCurrent - t._tickIntervalLast; 2 * e > t._tickInterval && (t.tick(), t._tickIntervalLast = t._tickIntervalCurrent) } else t.tick(); for (var n = t.children, i = n.length, r = 0; i > r; r++) { var a = n[r]; if (a) { if (a.tick) if (this._initInterval(a), a.hasOwnProperty("_tickInterval")) { a._tickIntervalCurrent = new Date, a._tickIntervalLast || (a._tickIntervalLast = new Date); var e = a._tickIntervalCurrent - a._tickIntervalLast; 2 * e > a._tickInterval && (a.tick(), a._tickIntervalLast = a._tickIntervalCurrent) } else a.tick(); "Container" == a.baseInstanceof && this._tick(a) } } }, _initInterval: function (t) { t.hasOwnProperty("tickFPS") && (t._tickInterval = 0 == t.tickFPS ? 1e4 : 1e3 / t.tickFPS) }, tick: function () { this.tickFn && this.tickFn(), this.update(), this.debug && (this.debugDiv.innerHTML = "fps : " + this.getFPS() + " <br/>object count : " + this.getTotalCount() + " <br/>rendering mode : " + this.getRenderingMode() + " <br/>inner object count  : " + this.innerObjectCount) }, onTick: function (t) { this.tickFn = t }, setFPS: function (t) { this.interval = Math.floor(1e3 / t) }, onKeyboard: function (e, n, i) { t.Keyboard.on(e, n, i) }, getActiveKeys: function () { return t.Keyboard.getActiveKeys() }, scalable: function (t, e) { 1 === t && 1 === e && (document.body.style.overflow = "hidden", document.documentElement.style.overflow = "hidden"), document.body.style.margin = 0, document.documentElement.style.margin = 0, document.body.style.border = 0, document.documentElement.style.border = 0, document.body.style.padding = 0, document.documentElement.style.padding = 0, document.body.style.width = "100%", document.documentElement.style.width = "100%", document.body.style.height = "100%", document.documentElement.style.height = "100%", this._scaleX = t, this._scaleY = e; var n = this.canvas; n.style.position = "absolute", n.style.width = 100 * t + "%", n.style.height = 100 * e + "%", n.style.left = 100 * (1 - t) / 2 + "%", n.style.top = 100 * (1 - e) / 2 + "%", n.style.border = "0px solid #ccc"; var i = this.domSurface; i.style.position = "absolute", i.style.width = 100 * t + "%", i.style.height = 100 * e + "%", i.style.left = 100 * (1 - t) / 2 + "%", i.style.top = 100 * (1 - e) / 2 + "%", i.style.border = "0px solid #ccc", i.style.transform = i.style.msTransform = i.style.OTransform = i.style.MozTransform = i.style.webkitTransform = "scale(" + window.innerWidth * this._scaleX / this.width + "," + window.innerHeight * this._scaleX / this.height + ")", this.offset = this._getXY(this.canvas) }, correctingXY: function (t, e) { return { x: t * this.width / (window.innerWidth * this._scaleX), y: e * this.height / (window.innerHeight * this._scaleY) } }, getTotalCount: function () { function i(r) { if ("Container" == r.baseInstanceof) for (var a = 0, s = r.children.length; s > a; a++) { var o = r.children[a]; o instanceof t.Container ? i(o) : (e++, o.inner && n.innerObjectCount++) } else e++ } var e = 0; this.innerObjectCount = 0; var n = this; return i(this), e }, getRenderingMode: function () { return this.renderer instanceof t.CanvasRenderer ? "Canvas" : "WebGL" }, getFPS: function () { return t.FPS.get() }, hideOuterObject: function (e) { for (var n = 0, i = e.children.length; i > n; n++) { var r = e.children[n]; r instanceof t.Container ? this.hideOuterObject(r) : r.inner = this.isInStage(r) } }, isInStage: function (t) { var e = t.getAABB(); return e ? this.collisionBetweenAABB(e, this.AABB) : !0 }, collisionBetweenAABB: function (t, e) { var n = t[0] + t[2]; if (n < e[0]) return !1; var i = t[0]; if (i > e[0] + e[2]) return !1; var r = t[1] + t[3]; if (r < e[1]) return !1; var r = t[1]; return r > e[1] + e[3] ? !1 : !0 } }), t.Sprite = t.DisplayObject.extend({ ctor: function (e) { this._super(), this.option = e, this.x = e.x || 0, this.y = e.y || 0, this.currentFrameIndex = 0, this.animationFrameIndex = 0, this.currentAnimation = e.currentAnimation || null, this.rect = [0, 0, 10, 10], this.visible = !1, this.bitmaps = [], this._loadedCount = 0; for (var i = this.option.imgs.length, r = 0; i > r; r++) { var a = this.option.imgs[r]; if ("string" == typeof a) if (t.Bitmap[a]) this.bitmaps.push(new t.Bitmap(t.Bitmap[a])), this._loadedCount++; else { var s = new t.Bitmap; s._sprite = this, s.onImageLoad(function () { s._sprite._loadedCount++, s._sprite._loadedCount === i && (s._sprite.visible = !0, delete s._sprite) }), s.useImage(this.option.imgs[r]), this.bitmaps.push(s) } else this._loadedCount++, this.bitmaps.push(new t.Bitmap(a)) } this._loadedCount === i && (this.visible = !0), this.img = this.bitmaps[0].img, this.interval = 1e3 / e.framerate, this.loop = null, this.paused = !1, this.animationEnd = e.animationEnd || null, this.currentAnimation && this.gotoAndPlay(this.currentAnimation), this.tickAnimationEnd = e.tickAnimationEnd || null }, play: function () { this.paused = !1 }, stop: function () { this.paused = !0 }, reset: function () { this.currentFrameIndex = 0, this.animationFrameIndex = 0 }, gotoAndPlay: function (t, e) { this.paused = !1, this.reset(), clearInterval(this.loop), this.currentAnimation = t; var n = this, i = 0; this.loop = setInterval(function () { if (!n.paused) { var t = n.option, r = t.animations[n.currentAnimation].frames, a = r.length; n.animationFrameIndex++, n.animationFrameIndex > a - 1 && (i++, n.animationFrameIndex = 0, n.tickAnimationEnd && n.tickAnimationEnd(), e && i == e && (n.animationEnd && n.animationEnd(), n.paused = !0, clearInterval(n.loop), n.parent.remove(n))), n.rect = t.frames[r[n.animationFrameIndex]], n.rect.length > 4 && (n.img = n.bitmaps[n.rect[4]].img) } }, this.interval) }, gotoAndStop: function (t) { this.reset(), clearInterval(this.loop); var e = this; e.currentAnimation = t; { var n = e.option, i = n.animations[e.currentAnimation].frames; i.length } e.rect = n.frames[i[e.animationFrameIndex]], e.rect.length > 4 && (e.img = e.bitmaps[e.rect[4]].img) } }), t.DomElement = t.DisplayObject.extend({ ctor: function (e) { this._super(), this.element = "string" == typeof e ? document.querySelector(e) : e; var i = (this.element, t.Observable.watch(this, ["x", "y", "scaleX", "scaleY", "perspective", "rotation", "skewX", "skewY", "regX", "regY"])), r = this; i.propertyChangedHandler = function () { var t = r._matrix.identity().appendTransform(r.x, r.y, r.scaleX, r.scaleY, r.rotation, r.skewX, r.skewY, r.regX, r.regY); r.element.style.transform = r.element.style.msTransform = r.element.style.OTransform = r.element.style.MozTransform = r.element.style.webkitTransform = "matrix(" + t.a + "," + t.b + "," + t.c + "," + t.d + "," + t.tx + "," + t.ty + ")" }, delete this.visible, Object.defineProperty(this, "visible", { set: function (t) { this._visible = t, this.element.style.display = this._visible ? "block" : "none" }, get: function () { return this._visible } }), delete this.alpha, Object.defineProperty(this, "alpha", { set: function (t) { this._opacity = t, this.element.style.opacity = t }, get: function () { return this._opacity } }), this.visible = !0, this.alpha = 1, this.element.style.display = "none" }, isVisible: function () { return !!(this.visible && this.alpha > 0 && 0 != this.scaleX && 0 != this.scaleY) } }), t.RAF = i.extend({ statics: { ctor: function () { var t = function () { return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function (t) { window.setTimeout(t, 1e3 / 60) } }(), e = function (e, n) { function a() { var s = (new Date).getTime(), o = s - i; o >= n && (e.call(), i = (new Date).getTime()), r.value = t(a) } if (!(window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame && window.mozCancelRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame)) return window.setInterval(e, n); var i = (new Date).getTime(), r = new Object; return r.value = t(a), r }, n = function (t) { t && setTimeout(function () { window.cancelAnimationFrame ? window.cancelAnimationFrame(t.value) : window.webkitCancelAnimationFrame ? window.webkitCancelAnimationFrame(t.value) : window.webkitCancelRequestAnimationFrame ? window.webkitCancelRequestAnimationFrame(t.value) : window.mozCancelRequestAnimationFrame ? window.mozCancelRequestAnimationFrame(t.value) : window.oCancelRequestAnimationFrame ? window.oCancelRequestAnimationFrame(t.value) : window.msCancelRequestAnimationFrame ? window.msCancelRequestAnimationFrame(t.value) : clearInterval(t) }, 0) }; this.requestInterval = e, this.clearRequestInterval = n } } }), t.CanvasRenderer = i.extend({ ctor: function (t) { t && (this.stage = t, this.ctx = t.ctx, this.height = t.width, this.width = t.height) }, update: function () { this.ctx.clearRect(0, 0, this.height, this.width), this.render(this.ctx, this.stage) }, render: function (e, n, i) { if (n.isVisible()) { if (n instanceof t.DomElement) return void (n.element.style.display = "block"); i ? n._matrix.reinitialize(i.a, i.b, i.c, i.d, i.tx, i.ty, i.alpha, i.shadow, i.compositeOperation) : n._matrix.reinitialize(1, 0, 0, 1, 0, 0), i = n._matrix, n instanceof t.Sprite && (n.regX = n.rect[2] * n.originX, n.regY = n.rect[3] * n.originY), i.appendTransform(n.x, n.y, n.scaleX, n.scaleY, n.rotation, n.skewX, n.skewY, n.regX, n.regY, n.filpX, n.flipY); var r = e.globalAlpha, a = e.globalCompositeOperation; e.globalAlpha *= n.alpha, e.globalCompositeOperation = n.compositeOperation; var s = n.cacheCanvas || n.txtCanvas || n.shapeCanvas; if (s) e.setTransform(i.a, i.b, i.c, i.d, i.tx, i.ty), e.drawImage(s, 0, 0); else if (n instanceof t.Container || n instanceof t.Stage) for (var o = n.children.slice(0), h = 0, c = o.length; c > h; h++) e.save(), this.render(e, o[h], i), e.restore(); else if (n instanceof t.Bitmap || n instanceof t.Sprite) { var l = n.rect; e.setTransform(i.a, i.b, i.c, i.d, i.tx, i.ty), e.drawImage(n.img, l[0], l[1], l[2], l[3], 0, 0, l[2], l[3]) } e.globalAlpha = r, e.globalCompositeOperation = a } }, hitRender: function (t, e, n, i, r, a) { t.clearRect(0, 0, 2, 2), n ? e._matrix.reinitialize(n.a, n.b, n.c, n.d, n.tx, n.ty, n.alpha, n.shadow, n.compositeOperation) : e._matrix.reinitialize(1, 0, 0, 1, 0, 0), n = e._matrix, n.appendTransform(e.x, e.y, e.scaleX, e.scaleY, e.rotation, e.skewX, e.skewY, e.regX, e.regY, e.filpX, e.flipY); for (var s = e.children.slice(0), o = s.length, h = o - 1; h >= 0; h--) { var c = s[h]; n.reinitialize(1, 0, 0, 1, 0, 0), n.appendTransform(e.x - i, e.y - r, e.scaleX, e.scaleY, e.rotation, e.skewX, e.skewY, e.regX, e.regY, e.filpX, e.flipY); var c = s[h]; this.isbindingEvent(c) && (t.save(), this._hitRender(t, s[h], n, a), t.restore()) } }, _hitRender: function (e, n, i, r) { if (n.isVisible()) { i ? n._matrix.reinitialize(i.a, i.b, i.c, i.d, i.tx, i.ty, i.alpha, i.shadow, i.compositeOperation) : n._matrix.reinitialize(1, 0, 0, 1, 0, 0), i = n._matrix, i.appendTransform(n.x, n.y, n.scaleX, n.scaleY, n.rotation, n.skewX, n.skewY, n.regX, n.regY, n.filpX, n.flipY); var a = e.globalAlpha; if (e.globalAlpha *= n.alpha, n.cacheCanvas) e.setTransform(i.a, i.b, i.c, i.d, i.tx, i.ty), e.drawImage(n.cacheCanvas || n.img, 0, 0); else if (n instanceof t.Container) for (var s = n.children.slice(0), o = s.length, h = o - 1; h >= 0; h--) { { s[h] } e.save(), this._hitRender(e, s[h], i, r), e.restore() } else if (n instanceof t.Bitmap || n instanceof t.Sprite) { var l = n.rect; e.setTransform(i.a, i.b, i.c, i.d, i.tx, i.ty), e.drawImage(n.img, l[0], l[1], l[2], l[3], 0, 0, l[2], l[3]) } e.getImageData(0, 0, 1, 1).data[3] > 1 && n.execEvent(r), e.globalAlpha = a } }, isbindingEvent: function (e) { if (0 !== Object.keys(e.events).length) return !0; if (e instanceof t.Container) for (var n = 0, i = e.children.length; i > n; n++) { var r = e.children[n]; if (r instanceof t.Container) return this.isbindingEvent(r); if (0 !== Object.keys(r.events).length) return !0 } return !1 }, updateCache: function (t, e, n, i) { t.clearRect(0, 0, n + 1, i + 1), this.renderCache(t, e) }, renderCache: function (e, n) { if (n.isVisible()) if (n instanceof t.Container || n instanceof t.Stage) for (var i = n.children.slice(0), r = 0, a = i.length; a > r; r++) e.save(), this.render(e, i[r]), e.restore(); else if (n instanceof t.Bitmap || n instanceof t.Sprite) { var s = n.rect; e.drawImage(n.img, s[0], s[1], s[2], s[3], 0, 0, s[2], s[3]) } else n.txtCanvas ? e.drawImage(n.txtCanvas, 0, 0) : n.shapeCanvas && e.drawImage(n.shapeCanvas, 0, 0) } }), t.WebGLRenderer = i.extend({ ctor: function (e) { this.root = e, this.surface = e.canvas, this.MAX_DEPTH = 1048576, this.snapToPixel = !0, this.canvasRenderer = new t.CanvasRenderer }, getSurface: function (t, e) { return null == this.surface && (this.surface = document.createElement("canvas")), t && (this.surface.width = t), e && (this.surface.height = e), this.surface }, clear: function () { this.surface && (this.surface.init || this.initSurface(this.surface)) }, initSurface: function (e) { var n = void 0; try { n = e.ctx = e.getContext("experimental-webgl", { preserveDrawingBuffer: !0 }), n.viewportWidth = e.width, n.viewportHeight = e.height } catch (i) { } n || alert("Could not initialise WebGL. Make sure you've updated your browser, or try a different one like Google Chrome."), e.idMatrix = t.GLMatrix.mat4.create(), e.orthMatrix = t.GLMatrix.mat4.create(), this._matPool = []; var r = n.createShader(n.FRAGMENT_SHADER); n.shaderSource(r, "precision highp float;\nvarying vec3 vTextureCoord;\nvarying float vAlpha;\nuniform float uAlpha;\nuniform sampler2D uSampler0;\nvoid main(void) { \nint sampler = int(vTextureCoord.z); \nvec4 color;\nvec2 coord = vec2(vTextureCoord.s, vTextureCoord.t);\n if (sampler == 0) { color = texture2D(uSampler0, coord); } \nelse { color = texture2D(uSampler0, vec2(vTextureCoord.s, vTextureCoord.t)); } \ngl_FragColor = vec4(color.rgb, color.a * vAlpha);\n}"), n.compileShader(r), n.getShaderParameter(r, n.COMPILE_STATUS) || alert(n.getShaderInfoLog(r)); var a = n.createShader(n.VERTEX_SHADER); n.shaderSource(a, "attribute vec3 aVertexPosition;\nattribute vec3 aTextureCoord;\nattribute float aAlpha;\nuniform mat4 uPMatrix;\nuniform bool uSnapToPixel;\nvarying vec3 vTextureCoord;\nvarying float vAlpha;\nvoid main(void) { \nvTextureCoord = aTextureCoord; \nvAlpha = aAlpha; \ngl_Position = uPMatrix * vec4(aVertexPosition, 1.0);\n}"), n.compileShader(a), n.getShaderParameter(a, n.COMPILE_STATUS) || alert(n.getShaderInfoLog(a)); var s = e.shader = n.createProgram(); n.attachShader(s, a), n.attachShader(s, r), n.linkProgram(s), n.getProgramParameter(s, n.LINK_STATUS) || alert("Could not initialise shaders"), n.enableVertexAttribArray(s.vertexPositionAttribute = n.getAttribLocation(s, "aVertexPosition")), n.enableVertexAttribArray(s.uvCoordAttribute = n.getAttribLocation(s, "aTextureCoord")), n.enableVertexAttribArray(s.colorAttribute = n.getAttribLocation(s, "aAlpha")), s.orthMatrixUniform = n.getUniformLocation(s, "uPMatrix"), s.alphaUniform = n.getUniformLocation(s, "uAlpha"), s.snapToUniform = n.getUniformLocation(s, "uSnapToPixel"), n.useProgram(s), this._vertexDataCount = 7, this._root2 = Math.sqrt(2), this._index = 0, this._textures = [], this._cacheTextures = [], this._degToRad = Math.PI / 180, this.vertices = window.Float32Array ? new window.Float32Array(4 * this._vertexDataCount * 5e3) : new Array(4 * this._vertexDataCount * 5e3), this.arrayBuffer = n.createBuffer(), this.indexBuffer = n.createBuffer(), n.bindBuffer(n.ARRAY_BUFFER, this.arrayBuffer), n.bindBuffer(n.ELEMENT_ARRAY_BUFFER, this.indexBuffer); var o = 4 * this._vertexDataCount; n.vertexAttribPointer(s.vertexPositionAttribute, 3, n.FLOAT, 0, o, 0), n.vertexAttribPointer(s.uvCoordAttribute, 3, n.FLOAT, 0, o, 12), n.vertexAttribPointer(s.colorAttribute, 1, n.FLOAT, 0, o, 24), this.indices = window.Uint16Array ? new window.Uint16Array(3e4) : new Array(3e4); for (var h = 0, c = this.indices.length; c > h; h += 6) { var l = 4 * h / 6; this.indices.set([l, l + 1, l + 2, l, l + 2, l + 3], h) } n.bufferData(n.ARRAY_BUFFER, this.vertices, n.STREAM_DRAW), n.bufferData(n.ELEMENT_ARRAY_BUFFER, this.indices, n.STATIC_DRAW), t.GLMatrix.mat4.ortho(0, n.viewportWidth, n.viewportHeight, 0, -this.MAX_DEPTH, this.MAX_DEPTH, e.orthMatrix), n.viewport(0, 0, n.viewportWidth, n.viewportHeight), n.colorMask(!0, !0, !0, !0), n.blendFuncSeparate(n.SRC_ALPHA, n.ONE_MINUS_SRC_ALPHA, n.SRC_ALPHA, n.ONE), n.enable(n.BLEND), n.disable(n.DEPTH_TEST), e.init = !0 }, _initTexture: function (t, e) { if (t) { for (var n = this._textures, i = this._cacheTextures.length + this._textures.length, r = 0, a = n.length; a > r; r++) if (n[r].image.src == t.src) return t.glTexture = n[r], r; return t.glTexture ? (e.activeTexture(e["TEXTURE" + i]), e.bindTexture(e.TEXTURE_2D, t.glTexture)) : (t.glTexture = e.createTexture(), t.glTexture.image = t, e.activeTexture(e["TEXTURE" + i]), e.bindTexture(e.TEXTURE_2D, t.glTexture), e.texImage2D(e.TEXTURE_2D, 0, e.RGBA, e.RGBA, e.UNSIGNED_BYTE, t.glTexture.image), e.texParameteri(e.TEXTURE_2D, e.TEXTURE_MAG_FILTER, e.LINEAR), e.texParameteri(e.TEXTURE_2D, e.TEXTURE_MIN_FILTER, e.LINEAR), e.texParameteri(e.TEXTURE_2D, e.TEXTURE_WRAP_S, e.CLAMP_TO_EDGE), e.texParameteri(e.TEXTURE_2D, e.TEXTURE_WRAP_T, e.CLAMP_TO_EDGE)), e.uniform1i(e.getUniformLocation(e.canvas.shader, "uSampler" + i.toString()), i), n.push(t.glTexture), i } }, _initCache: function (t, e, n) { if (e) { for (var i = this._cacheTextures, r = this._textures.length, a = 0, s = i.length; s > a; a++) if (t.cacheID && i[a]._cacheID == t.cacheID) return i[a]._isUsed = !0, e.glTexture = i[a], n.activeTexture(n["TEXTURE" + r]), n.bindTexture(n.TEXTURE_2D, e.glTexture), this._textures.push(e.glTexture), a; return e.glTexture ? (n.activeTexture(n["TEXTURE" + r]), n.bindTexture(n.TEXTURE_2D, e.glTexture)) : (e.glTexture = n.createTexture(), e.glTexture.image = e, n.activeTexture(n["TEXTURE" + r]), n.bindTexture(n.TEXTURE_2D, e.glTexture), n.texImage2D(n.TEXTURE_2D, 0, n.RGBA, n.RGBA, n.UNSIGNED_BYTE, e.glTexture.image), n.texParameteri(n.TEXTURE_2D, n.TEXTURE_MAG_FILTER, n.LINEAR), n.texParameteri(n.TEXTURE_2D, n.TEXTURE_MIN_FILTER, n.LINEAR), n.texParameteri(n.TEXTURE_2D, n.TEXTURE_WRAP_S, n.CLAMP_TO_EDGE), n.texParameteri(n.TEXTURE_2D, n.TEXTURE_WRAP_T, n.CLAMP_TO_EDGE)), n.uniform1i(n.getUniformLocation(n.canvas.shader, "uSampler" + r.toString()), r), e.glTexture._cacheID = t.cacheID, e.glTexture._isUsed = !0, this._textures.push(e.glTexture), r } }, render: function (e, n) { e = e || this.root, n = n || this.surface; var i = n.ctx; this.snapToPixel ? i.uniform1i(n.shader.snapToUniform, 1) : i.uniform1i(n.shader.snapToUniform, 0), t.GLMatrix.mat4.identity(n.idMatrix), i.clear(i.COLOR_BUFFER_BIT | i.DEPTH_BUFFER_BIT), i.uniformMatrix4fv(n.shader.orthMatrixUniform, !1, n.orthMatrix), n.init || this.initSurface(n), e && n && (this._render(i, e, n.idMatrix), this._draw(i)), this._cleanCache() }, _getCompositeOperation: function (t) { return t.compositeOperation ? t.compositeOperation : t.parent ? this._getCompositeOperation(t.parent) : void 0 }, _getAlpha: function (t, e) { var n = t.alpha * e; return t.parent ? this._getAlpha(t.parent, n) : n }, _render: function (e, n, i) { if (n.isVisible()) { if (n instanceof t.DomElement) return void (n.element.style.display = "block"); var r = t.GLMatrix.mat4, a = (this._index + 4) * this._vertexDataCount; this.vertices.length < a && this._draw(e); var s = 0, o = 0, h = 1, c = 1, l = 0, u = this._degToRad, f = this._getMat4(), d = 0, m = this._getCompositeOperation(n); "lighter" === m ? e.blendFunc(e.SRC_ALPHA, e.ONE) : e.blendFunc(e.SRC_ALPHA, e.ONE_MINUS_SRC_ALPHA); var p = n.cacheCanvas || n.txtCanvas || n.shapeCanvas; if (p) d = this._initCache(n, p, e), r.translate(i, [n.x, n.y, 0], f), r.rotateX(f, n.skewX * u), r.rotateY(f, n.skewY * u), r.rotateZ(f, n.rotation * u), r.scale(f, [n.scaleX * p.width, n.scaleY * p.height, 1]), r.translate(f, [-n.originX, -n.originY, 0]); else { if (n instanceof t.Container) { var g = n.children.slice(0); r.translate(i, [n.x, n.y, 0], f), r.rotateX(f, n.skewX * u), r.rotateY(f, n.skewY * u), r.rotateZ(f, n.rotation * u), r.scale(f, [n.scaleX, n.scaleY, 1]), r.translate(f, [-n.originX, -n.originY, 0]); for (var v = 0, w = g.length; w > v; v++) this._render(e, g[v], f); return void this._poolMat4(f) } if (n instanceof t.Bitmap || n instanceof t.Sprite) { var y = n.rect; l = n.img, d = this._initTexture(l, e), h = y[2] / l.width, c = y[3] / l.height, s = y[0] / l.width, o = y[1] / l.height, r.translate(i, [n.x, n.y, 0], f), r.rotateX(f, n.skewX * u), r.rotateY(f, n.skewY * u), r.rotateZ(f, n.rotation * u), r.scale(f, [n.scaleX * y[2], n.scaleY * y[3], 1]), r.translate(f, [-n.originX, -n.originY, 0]) } } var b = r.multiplyVec3(f, [0, 0, 0]), _ = r.multiplyVec3(f, [0, 1, 0]), x = r.multiplyVec3(f, [1, 1, 0]), C = r.multiplyVec3(f, [1, 0, 0]), A = this._getAlpha(n, 1); this.vertices.set([b[0], b[1], b[2], s, o, d, A, _[0], _[1], _[2], s, o + c, d, A, x[0], x[1], x[2], s + h, o + c, d, A, C[0], C[1], C[2], s + h, o, d, A], this._index * this._vertexDataCount), this._index += 4, this._poolMat4(f), this._draw(e) } }, _draw: function (t) { t.bufferSubData(t.ARRAY_BUFFER, 0, this.vertices.subarray(0, this._index * this._vertexDataCount)), t.drawElements(t.TRIANGLES, 1.5 * this._index, t.UNSIGNED_SHORT, 0), this._index = 0, this._textureCount = 0, this._textures = [] }, _cleanCache: function () { for (var t = this._cacheTextures, e = 0, n = t.length; n > e; e++) t[e]._isUsed ? t[e]._isUsed = !1 : (t.splice(e, 1), e--, n--) }, _getMat4: function () { return this._matPool.length > 0 ? this._matPool.pop() : t.GLMatrix.mat4.create() }, _poolMat4: function (t) { this._matPool.push(t) }, update: function () { this.clear(), this.tickOnUpdate && this.tickDisplayList(this.root, this.arguments), this.render(this.root, this.surface) }, updateCache: function (t, e, n, i) { t.clearRect(0, 0, n + 1, i + 1), this.renderCache(t, e) }, renderCache: function (e, n) { if (n.isVisible()) if (n instanceof t.Container || n instanceof t.Stage) for (var i = n.children.slice(0), r = 0, a = i.length; a > r; r++) e.save(), this.canvasRenderer.render(e, i[r]), e.restore(); else if (n instanceof t.Bitmap || n instanceof t.Sprite) { var s = n.rect; e.drawImage(n.img, s[0], s[1], s[2], s[3], 0, 0, s[2], s[3]) } else n.txtCanvas ? e.drawImage(n.txtCanvas, 0, 0) : n.shapeCanvas && e.drawImage(n.shapeCanvas, 0, 0) } }), t.Loader = i.extend({ ctor: function () { this.audios = {}, this.res = {}, this.loadedCount = 0, this.resCount = -1, this.FILE_PATTERN = /(\w+:\/{2})?((?:\w+\.){2}\w+)?(\/?[\S]+\/|\/)?([\w\-%\.]+)(?:\.)(\w+)?(\?\S+)?/i, this.ns = 3, this.sounds = []; for (var t = 0; t < this.ns; t++) this.sounds.push([]); this.playing = [], this.soundsCount = 0 }, get: function (t) { return this.res[t] }, loadRes: function (t) { this.resCount = t.length; for (var e = 0; e < t.length; e++) "audio" == this._getTypeByExtension(t[e].src.match(this.FILE_PATTERN)[5]) ? this.loadAudio(t[e].id, t[e].src) : this.loadImage(t[e].id, t[e].src) }, loadImage: function (t, e) { var n = document.createElement("img"), i = this; n.onload = function () { i._handleLoad(this, t), n.onreadystatechange = null }, n.onreadystatechange = function () { ("loaded" == n.readyState || "complete" == n.readyState) && (i._handleLoad(this, t), n.onload = null) }, n.onerror = function () { }, n.src = e }, loadAudio: function (t, e) { var n = document.createElement("audio"); n.autoplay = !1, this.res[t] = n, n.src = null, n.preload = "auto", n.onerror = function () { }, n.onstalled = function () { }; var i = this, r = function () { i.playing[t] = 0; for (var n = 0; n < i.ns; n++) i.sounds[n][t] = new Audio(e); i.loadedCount++, i.handleProgress(i.loadedCount, i.resCount), i._clean(this), this.removeEventListener && this.removeEventListener("canplaythrough", r, !1), i.checkComplete() }; n.addEventListener("canplaythrough", r, !1), n.src = e, null != n.load && n.load() }, checkComplete: function () { this.loadedCount === this.resCount && this.handleComplete() }, complete: function (t) { this.handleComplete = t }, progress: function (t) { this.handleProgress = t }, playSound: function (t) { this.sounds[this.playing[t]][t].play(), ++this.playing[t], this.playing[t] >= this.ns && (this.playing[t] = 0) }, _handleLoad: function (t, e) { this._clean(t), this.res[e] = t, this.loadedCount++, this.handleProgress && this.handleProgress(this.loadedCount, this.resCount), this.checkComplete() }, _getTypeByExtension: function (t) { switch (t) { case "jpeg": case "jpg": case "gif": case "png": case "webp": case "bmp": return "img"; case "ogg": case "mp3": case "wav": return "audio" } }, _clean: function (t) { t.onload = null, t.onstalled = null, t.onprogress = null, t.onerror = null } }), t.FPS = i.extend({ statics: { get: function () { return this.instance || (this.instance = new this), this.instance._computeFPS(), this.instance.value } }, ctor: function () { this.last = new Date, this.current = null, this.value = 0, this.fpsList = []; var t = this; setInterval(function () { var e = t.fpsList.length - 1; t.value = t.fpsList[e], e > 500 && t.fpsList.shift() }, 500) }, _computeFPS: function () { this.current = new Date; var t = Math.ceil(1e3 / (this.current - this.last)); this.fpsList.push(t > 60 ? 60 : t), this.last = this.current } }), t.Keyboard = i.extend({
                    statics: {
                        ctor: function () {
                            function u() {
                                window.addEventListener ? (window.document.addEventListener("keydown", m, !1), window.document.addEventListener("keyup", p, !1), window.addEventListener("blur", d, !1), window.addEventListener("webkitfullscreenchange", d, !1), window.addEventListener("mozfullscreenchange", d, !1)) : window.attachEvent && (window.document.attachEvent("onkeydown", m), window.document.attachEvent("onkeyup", p), window.attachEvent("onblur", d))
                            } function f() { d(), window.removeEventListener ? (window.document.removeEventListener("keydown", m, !1), window.document.removeEventListener("keyup", p, !1), window.removeEventListener("blur", d, !1), window.removeEventListener("webkitfullscreenchange", d, !1), window.removeEventListener("mozfullscreenchange", d, !1)) : window.detachEvent && (window.document.detachEvent("onkeydown", m), window.document.detachEvent("onkeyup", p), window.detachEvent("onblur", d)) } function d(t) { a = [], _(), E(t) } function m(t) { var e, n, i; if (e = g(t.keyCode), !(e.length < 1)) { for (t.isRepeat = !1, i = 0; i < e.length; i += 1) n = e[i], -1 != M().indexOf(n) && (t.isRepeat = !0), S(n); b(), T(t) } } function p(t) { var e, n; if (e = g(t.keyCode), !(e.length < 1)) { for (n = 0; n < e.length; n += 1) L(e[n]); _(), E(t) } } function g(t) { return i[t] || [] } function v(t) { var e; for (e in i) if (i.hasOwnProperty(e) && i[e].indexOf(t) > -1) return e; return !1 } function w(t, e) { if ("string" != typeof t && ("object" != typeof t || "function" != typeof t.push)) throw new Error("Cannot create macro. The combo must be a string or array."); if ("object" != typeof e || "function" != typeof e.push) throw new Error("Cannot create macro. The injectedKeys must be an array."); r.push([t, e]) } function y(t) { var e, n; if ("string" != typeof t && ("object" != typeof t || "function" != typeof t.push)) throw new Error("Cannot remove macro. The combo must be a string or array."); for (n = 0; n < r.length; n += 1) if (e = r[n], k(t, e[0])) { L(e[1]), r.splice(n, 1); break } } function b() { var t, e, n; for (t = 0; t < r.length; t += 1) if (e = D(r[t][0]), -1 === h.indexOf(r[t]) && R(e)) for (h.push(r[t]), n = 0; n < r[t][1].length; n += 1) S(r[t][1][n]) } function _() { var t, e, n; for (t = 0; t < h.length; t += 1) if (e = D(h[t][0]), R(e) === !1) { for (n = 0; n < h[t][1].length; n += 1) L(h[t][1][n]); h.splice(t, 1), t -= 1 } } function x(t, e, n) { function l() { var t; for (t = 0; t < a.length; t += 1) s.splice(s.indexOf(a[t]), 1) } function u(t) { function s() { var e, i; for (e = 0; e < n.length; e += 1) if ("function" == typeof n[e]) if ("keyup" === t) for (i = 0; i < a.length; i += 1) a[i].keyUpCallback.splice(a[i].keyUpCallback.indexOf(n[e]), 1); else for (i = 0; i < a.length; i += 1) a[i].keyDownCallback.splice(a[i].keyDownCallback.indexOf(n[e]), 1) } var n, i, r, e = {}; if ("string" != typeof t) throw new Error("Cannot bind callback. The event name must be a string."); if ("keyup" !== t && "keydown" !== t) throw new Error('Cannot bind callback. The event name must be a "keyup" or "keydown".'); for (n = Array.prototype.slice.apply(arguments, [1]), i = 0; i < n.length; i += 1) if ("function" == typeof n[i]) if ("keyup" === t) for (r = 0; r < a.length; r += 1) a[r].keyUpCallback.push(n[i]); else if ("keydown" === t) for (r = 0; r < a.length; r += 1) a[r].keyDownCallback.push(n[i]); return e.clear = s, e } var r, h, c, i = {}, a = []; for ("string" == typeof t && (t = D(t)), h = 0; h < t.length; h += 1) { if (r = {}, c = X([t[h]]), "string" != typeof c) throw new Error("Failed to bind key combo. The key combo must be string."); r.keyCombo = c, r.keyDownCallback = [], r.keyUpCallback = [], e && r.keyDownCallback.push(e), n && r.keyUpCallback.push(n), s.push(r), a.push(r) } return i.clear = l, i.on = u, i } function C(t) { var e, n; for (e = 0; e < s.length; e += 1) n = s[e], k(t, n.keyCombo) && (s.splice(e, 1), e -= 1) } function A(t) { var e, n, i; if (t) { for (e = 0; e < s.length; e += 1) for (i = s[e], n = 0; n < i.keyCombo.length; n += 1) if (i.keyCombo[n].indexOf(t) > -1) { s.splice(e, 1), e -= 1; break } } else s = [] } function T(t) { var e, n, i, r, h, c, l, u, f, d, p, m = []; for (h = [].concat(a), e = 0; e < s.length; e += 1) p = I(s[e].keyCombo).length, m[p] || (m[p] = []), m[p].push(s[e]); for (n = m.length - 1; n >= 0; n -= 1) if (m[n]) for (e = 0; e < m[n].length; e += 1) { for (i = m[n][e], r = I(i.keyCombo), f = !0, u = 0; u < r.length; u += 1) if (-1 === h.indexOf(r[u])) { f = !1; break } if (f && R(i.keyCombo)) { for (o.push(i), u = 0; u < r.length; u += 1) d = h.indexOf(r[u]), d > -1 && (h.splice(d, 1), u -= 1); for (c = 0; c < i.keyDownCallback.length; c += 1) i.keyDownCallback[c](t, M(), i.keyCombo) === !1 && (l = !0); l === !0 && (t.preventDefault(), t.stopPropagation()) } } } function E(t) { var e, n, i, r; for (e = 0; e < o.length; e += 1) if (i = o[e], R(i.keyCombo) === !1) { for (n = 0; n < i.keyUpCallback.length; n += 1) i.keyUpCallback[n](t, M(), i.keyCombo) === !1 && (r = !0); r === !0 && (t.preventDefault(), t.stopPropagation()), o.splice(e, 1), e -= 1 } } function k(t, e) { var n, i, r; if (t = D(t), e = D(e), t.length !== e.length) return !1; for (n = 0; n < t.length; n += 1) { if (t[n].length !== e[n].length) return !1; for (i = 0; i < t[n].length; i += 1) { if (t[n][i].length !== e[n][i].length) return !1; for (r = 0; r < t[n][i].length; r += 1) if (-1 === e[n][i].indexOf(t[n][i][r])) return !1 } } return !0 } function R(t) { var e, n, i, r, o, h, s = 0; for (t = D(t), e = 0; e < t.length; e += 1) { for (h = !0, s = 0, n = 0; n < t[e].length; n += 1) { for (i = [].concat(t[e][n]), r = s; r < a.length; r += 1) o = i.indexOf(a[r]), o > -1 && (i.splice(o, 1), s = r); if (0 !== i.length) { h = !1; break } } if (h) return !0 } return !1 } function I(t) { var e, n, r = []; for (t = D(t), e = 0; e < t.length; e += 1) for (n = 0; n < t[e].length; n += 1) r = r.concat(t[e][n]); return r } function D(t) { var e = t, n = 0, i = 0, r = !1, a = !1, s = [], o = [], h = [], c = ""; if ("object" == typeof t && "function" == typeof t.push) return t; if ("string" != typeof t) throw new Error('Cannot parse "keyCombo" because its type is "' + typeof t + '". It must be a "string".'); for (; " " === e.charAt(n) ;) n += 1; for (; ;) { if (" " === e.charAt(n)) { for (; " " === e.charAt(n) ;) n += 1; r = !0 } else if ("," === e.charAt(n)) { if (i || a) throw new Error("Failed to parse key combo. Unexpected , at character index " + n + "."); a = !0, n += 1 } else if ("+" === e.charAt(n)) { if (c.length && (h.push(c), c = ""), i || a) throw new Error("Failed to parse key combo. Unexpected + at character index " + n + "."); i = !0, n += 1 } else if (">" === e.charAt(n)) { if (c.length && (h.push(c), c = ""), h.length && (o.push(h), h = []), i || a) throw new Error("Failed to parse key combo. Unexpected > at character index " + n + "."); i = !0, n += 1 } else if (n < e.length - 1 && "!" === e.charAt(n) && (">" === e.charAt(n + 1) || "," === e.charAt(n + 1) || "+" === e.charAt(n + 1))) c += e.charAt(n + 1), i = !1, r = !1, a = !1, n += 2; else { if (!(n < e.length && "+" !== e.charAt(n) && ">" !== e.charAt(n) && "," !== e.charAt(n) && " " !== e.charAt(n))) { n += 1; continue } for ((i === !1 && r === !0 || a === !0) && (c.length && (h.push(c), c = ""), h.length && (o.push(h), h = []), o.length && (s.push(o), o = [])), i = !1, r = !1, a = !1; n < e.length && "+" !== e.charAt(n) && ">" !== e.charAt(n) && "," !== e.charAt(n) && " " !== e.charAt(n) ;) c += e.charAt(n), n += 1 } if (n >= e.length) { c.length && (h.push(c), c = ""), h.length && (o.push(h), h = []), o.length && (s.push(o), o = []); break } } return s } function X(t) { var e, n, i = []; if ("string" == typeof t) return t; if ("object" != typeof t || "function" != typeof t.push) throw new Error("Cannot stringify key combo."); for (e = 0; e < t.length; e += 1) { for (i[e] = [], n = 0; n < t[e].length; n += 1) i[e][n] = t[e][n].join(" + "); i[e] = i[e].join(" > ") } return i.join(" ") } function M() { return [].concat(a) } function S(t) { if (t.match(/\s/)) throw new Error("Cannot add key name " + t + " to active keys because it contains whitespace."); a.indexOf(t) > -1 || a.push(t) } function L(t) { var e = v(t); "91" === e || "92" === e ? a = [] : a.splice(a.indexOf(t), 1) } function P(t, n) { if ("string" != typeof t) throw new Error("Cannot register new locale. The locale name must be a string."); if ("object" != typeof n) throw new Error("Cannot register " + t + " locale. The locale map must be an object."); if ("object" != typeof n.map) throw new Error("Cannot register " + t + " locale. The locale map is invalid."); n.macros || (n.macros = []), e[t] = n } function O(t) { if (t) { if ("string" != typeof t) throw new Error("Cannot set locale. The locale name must be a string."); if (!e[t]) throw new Error("Cannot set locale to " + t + " because it does not exist. If you would like to submit a " + t + " locale map for KeyboardJS please submit it at https://github.com/RobertWHurst/KeyboardJS/issues."); i = e[t].map, r = e[t].macros, n = t } return n } var n, i, r, c, l, t = {}, e = {}, a = [], s = [], o = [], h = []; for (l = { map: { 3: ["cancel"], 8: ["backspace"], 9: ["tab"], 12: ["clear"], 13: ["enter"], 16: ["shift"], 17: ["ctrl"], 18: ["alt", "menu"], 19: ["pause", "break"], 20: ["capslock"], 27: ["escape", "esc"], 32: ["space", "spacebar"], 33: ["pageup"], 34: ["pagedown"], 35: ["end"], 36: ["home"], 37: ["left"], 38: ["up"], 39: ["right"], 40: ["down"], 41: ["select"], 42: ["printscreen"], 43: ["execute"], 44: ["snapshot"], 45: ["insert", "ins"], 46: ["delete", "del"], 47: ["help"], 91: ["command", "windows", "win", "super", "leftcommand", "leftwindows", "leftwin", "leftsuper"], 92: ["command", "windows", "win", "super", "rightcommand", "rightwindows", "rightwin", "rightsuper"], 145: ["scrolllock", "scroll"], 186: ["semicolon", ";"], 187: ["equal", "equalsign", "="], 188: ["comma", ","], 189: ["dash", "-"], 190: ["period", "."], 191: ["slash", "forwardslash", "/"], 192: ["graveaccent", "`"], 219: ["openbracket", "["], 220: ["backslash", "\\"], 221: ["closebracket", "]"], 222: ["apostrophe", "'"], 48: ["zero", "0"], 49: ["one", "1"], 50: ["two", "2"], 51: ["three", "3"], 52: ["four", "4"], 53: ["five", "5"], 54: ["six", "6"], 55: ["seven", "7"], 56: ["eight", "8"], 57: ["nine", "9"], 96: ["numzero", "num0"], 97: ["numone", "num1"], 98: ["numtwo", "num2"], 99: ["numthree", "num3"], 100: ["numfour", "num4"], 101: ["numfive", "num5"], 102: ["numsix", "num6"], 103: ["numseven", "num7"], 104: ["numeight", "num8"], 105: ["numnine", "num9"], 106: ["nummultiply", "num*"], 107: ["numadd", "num+"], 108: ["numenter"], 109: ["numsubtract", "num-"], 110: ["numdecimal", "num."], 111: ["numdivide", "num/"], 144: ["numlock", "num"], 112: ["f1"], 113: ["f2"], 114: ["f3"], 115: ["f4"], 116: ["f5"], 117: ["f6"], 118: ["f7"], 119: ["f8"], 120: ["f9"], 121: ["f10"], 122: ["f11"], 123: ["f12"] }, macros: [["shift + `", ["tilde", "~"]], ["shift + 1", ["exclamation", "exclamationpoint", "!"]], ["shift + 2", ["at", "@"]], ["shift + 3", ["number", "#"]], ["shift + 4", ["dollar", "dollars", "dollarsign", "$"]], ["shift + 5", ["percent", "%"]], ["shift + 6", ["caret", "^"]], ["shift + 7", ["ampersand", "and", "&"]], ["shift + 8", ["asterisk", "*"]], ["shift + 9", ["openparen", "("]], ["shift + 0", ["closeparen", ")"]], ["shift + -", ["underscore", "_"]], ["shift + =", ["plus", "+"]], ["shift + (", ["opencurlybrace", "opencurlybracket", "{"]], ["shift + )", ["closecurlybrace", "closecurlybracket", "}"]], ["shift + \\", ["verticalbar", "|"]], ["shift + ;", ["colon", ":"]], ["shift + '", ["quotationmark", '"']], ["shift + !,", ["openanglebracket", "<"]], ["shift + .", ["closeanglebracket", ">"]], ["shift + /", ["questionmark", "?"]]] }, c = 65; 90 >= c; c += 1) l.map[c] = String.fromCharCode(c + 32), l.macros.push(["shift + " + String.fromCharCode(c + 32) + ", capslock + " + String.fromCharCode(c + 32), [String.fromCharCode(c)]]); P("us", l), O("us"), u(), t.enable = u, t.disable = f, t.activeKeys = M, t.releaseKey = L, t.pressKey = S, t.on = x, t.clear = C, t.clear.key = A, t.locale = O, t.locale.register = P, t.macro = w, t.macro.remove = y, t.key = {}, t.key.name = g, t.key.code = v, t.combo = {}, t.combo.active = R, t.combo.parse = D, t.combo.stringify = X, this.Keyboard = t
                        }, on: function (t, e, n) { this.Keyboard.on(t, e, n) }, getActiveKeys: function () { return this.Keyboard.activeKeys() }
                    }
                }), t.Bitmap = t.DisplayObject.extend({ ctor: function (t) { this._super(), 0 !== arguments.length && ("string" == typeof t ? this._initWithSrc(t) : this._init(t)) }, _initWithSrc: function (e) { var n = t.Bitmap[e]; if (n) this._init(n); else { var i = this; this.visible = !1, this.img = document.createElement("img"), this.img.onload = function () { i.rect || (i.rect = [0, 0, i.img.width, i.img.height]), i.width = i.rect[2], i.height = i.rect[3], i.regX = i.width * i.originX, i.regY = i.height * i.originY, i.imgLoaded = !0, t.Bitmap[e] = i.img, i.visible = !0, i.imageLoadHandle && i.imageLoadHandle(), i.filter && (i.filter = i.filter) }, this.img.src = e } }, _init: function (t) { this.img = t, this.width = t.width, this.height = t.height, this.imgLoaded = !0, Object.defineProperty(this, "rect", { get: function () { return this.__rect }, set: function (t) { this.__rect = t, this.width = t[2], this.height = t[3], this.regX = t[2] * this.originX, this.regY = t[3] * this.originY } }), this.rect = [0, 0, t.width, t.height] }, useImage: function (t) { "string" == typeof t ? this._initWithSrc(t) : (this._init(t), this.imageLoadHandle && this.imageLoadHandle()) }, onImageLoad: function (t) { this.imageLoadHandle = t }, clone: function () { var e = new t.Bitmap(this.img); return e.rect = this.rect.slice(0), this.cloneProps(e), e } }), t.Observable = i.extend({ statics: { ctor: function () { this.methods = ["concat", "every", "filter", "forEach", "indexOf", "join", "lastIndexOf", "map", "pop", "push", "reduce", "reduceRight", "reverse", "shift", "slice", "some", "sort", "splice", "unshift", "valueOf"], this.triggerStr = ["concat", "pop", "push", "reverse", "shift", "sort", "splice", "unshift"].join(",") }, type: function (t) { var e = Object.prototype.toString.call(t).split(" ")[1]; return e.substr(0, e.length - 1).toLowerCase() }, isArray: function (t) { return "array" == this.type(t) }, isInArray: function (t, e) { for (var n = t.length; --n > -1;) if (e === t[n]) return !0; return !1 }, isFunction: function (t) { return "function" == this.type(t) }, watch: function (t, e) { return new this(t, e) } }, ctor: function (e, n) { for (var i in e) e.hasOwnProperty(i) && (n && t.Observable.isInArray(n, i) || !n) && this.watch(e, i); if (e.change) throw "naming conflicts！observable will extend 'change' method to your object ."; var r = this; e.change = function (t) { r.propertyChangedHandler = t } }, onPropertyChanged: function (t, e) { this.propertyChangedHandler && this.propertyChangedHandler(t, e) }, mock: function (e) { var n = this; t.Observable.methods.forEach(function (i) { e[i] = function () { var e = Array.prototype[i].apply(this, Array.prototype.slice.call(arguments)); for (var r in this) this.hasOwnProperty(r) && "_super" != r && !t.Observable.isFunction(this[r]) && n.watch(this, r); return new RegExp("\\b" + i + "\\b").test(t.Observable.triggerStr) && n.onPropertyChanged("array", i), e } }) }, watch: function (e, n) { if ("__" != n.substr(0, 2)) { var i = this; if (!t.Observable.isFunction(e[n])) { var r = e["__" + n] = e[n]; if (Object.defineProperty(e, n, { get: function () { return this["__" + n] }, set: function (t) { this["__" + n] = t, i.onPropertyChanged(n, t) } }), t.Observable.isArray(e) && this.mock(e), "object" == typeof r) { t.Observable.isArray(r) && this.mock(r); for (var a in r) r.hasOwnProperty(a) && "_super" != a && this.watch(r, a) } } } } }), t.GLMatrix = i.extend({ statics: { ctor: function () { var t = "undefined" != typeof window.Float32Array ? window.Float32Array : "undefined" != typeof window.WebGLFloatArray ? window.WebGLFloatArray : Array, e = {}; e.create = function (e) { var n = new t(3); return e && (n[0] = e[0], n[1] = e[1], n[2] = e[2]), n }, e.set = function (t, e) { return e[0] = t[0], e[1] = t[1], e[2] = t[2], e }, e.add = function (t, e, n) { return n && t != n ? (n[0] = t[0] + e[0], n[1] = t[1] + e[1], n[2] = t[2] + e[2], n) : (t[0] += e[0], t[1] += e[1], t[2] += e[2], t) }, e.subtract = function (t, e, n) { return n && t != n ? (n[0] = t[0] - e[0], n[1] = t[1] - e[1], n[2] = t[2] - e[2], n) : (t[0] -= e[0], t[1] -= e[1], t[2] -= e[2], t) }, e.negate = function (t, e) { return e || (e = t), e[0] = -t[0], e[1] = -t[1], e[2] = -t[2], e }, e.scale = function (t, e, n) { return n && t != n ? (n[0] = t[0] * e, n[1] = t[1] * e, n[2] = t[2] * e, n) : (t[0] *= e, t[1] *= e, t[2] *= e, t) }, e.normalize = function (t, e) { e || (e = t); var n = t[0], i = t[1], r = t[2], a = Math.sqrt(n * n + i * i + r * r); return a ? 1 == a ? (e[0] = n, e[1] = i, e[2] = r, e) : (a = 1 / a, e[0] = n * a, e[1] = i * a, e[2] = r * a, e) : (e[0] = 0, e[1] = 0, e[2] = 0, e) }, e.cross = function (t, e, n) { n || (n = t); var i = t[0], r = t[1]; t = t[2]; var a = e[0], s = e[1]; return e = e[2], n[0] = r * e - t * s, n[1] = t * a - i * e, n[2] = i * s - r * a, n }, e.length = function (t) { var e = t[0], n = t[1]; return t = t[2], Math.sqrt(e * e + n * n + t * t) }, e.dot = function (t, e) { return t[0] * e[0] + t[1] * e[1] + t[2] * e[2] }, e.direction = function (t, e, n) { n || (n = t); var i = t[0] - e[0], r = t[1] - e[1]; return t = t[2] - e[2], (e = Math.sqrt(i * i + r * r + t * t)) ? (e = 1 / e, n[0] = i * e, n[1] = r * e, n[2] = t * e, n) : (n[0] = 0, n[1] = 0, n[2] = 0, n) }, e.lerp = function (t, e, n, i) { return i || (i = t), i[0] = t[0] + n * (e[0] - t[0]), i[1] = t[1] + n * (e[1] - t[1]), i[2] = t[2] + n * (e[2] - t[2]), i }, e.str = function (t) { return "[" + t[0] + ", " + t[1] + ", " + t[2] + "]" }; var n = {}; n.create = function (e) { var n = new t(9); return e && (n[0] = e[0], n[1] = e[1], n[2] = e[2], n[3] = e[3], n[4] = e[4], n[5] = e[5], n[6] = e[6], n[7] = e[7], n[8] = e[8], n[9] = e[9]), n }, n.set = function (t, e) { return e[0] = t[0], e[1] = t[1], e[2] = t[2], e[3] = t[3], e[4] = t[4], e[5] = t[5], e[6] = t[6], e[7] = t[7], e[8] = t[8], e }, n.identity = function (t) { return t[0] = 1, t[1] = 0, t[2] = 0, t[3] = 0, t[4] = 1, t[5] = 0, t[6] = 0, t[7] = 0, t[8] = 1, t }, n.transpose = function (t, e) { if (!e || t == e) { var n = t[1], i = t[2], r = t[5]; return t[1] = t[3], t[2] = t[6], t[3] = n, t[5] = t[7], t[6] = i, t[7] = r, t } return e[0] = t[0], e[1] = t[3], e[2] = t[6], e[3] = t[1], e[4] = t[4], e[5] = t[7], e[6] = t[2], e[7] = t[5], e[8] = t[8], e }, n.toMat4 = function (t, e) { return e || (e = i.create()), e[0] = t[0], e[1] = t[1], e[2] = t[2], e[3] = 0, e[4] = t[3], e[5] = t[4], e[6] = t[5], e[7] = 0, e[8] = t[6], e[9] = t[7], e[10] = t[8], e[11] = 0, e[12] = 0, e[13] = 0, e[14] = 0, e[15] = 1, e }, n.str = function (t) { return "[" + t[0] + ", " + t[1] + ", " + t[2] + ", " + t[3] + ", " + t[4] + ", " + t[5] + ", " + t[6] + ", " + t[7] + ", " + t[8] + "]" }; var i = {}; i.create = function (e) { var n = new t(16); return e && (n[0] = e[0], n[1] = e[1], n[2] = e[2], n[3] = e[3], n[4] = e[4], n[5] = e[5], n[6] = e[6], n[7] = e[7], n[8] = e[8], n[9] = e[9], n[10] = e[10], n[11] = e[11], n[12] = e[12], n[13] = e[13], n[14] = e[14], n[15] = e[15]), n }, i.set = function (t, e) { return e[0] = t[0], e[1] = t[1], e[2] = t[2], e[3] = t[3], e[4] = t[4], e[5] = t[5], e[6] = t[6], e[7] = t[7], e[8] = t[8], e[9] = t[9], e[10] = t[10], e[11] = t[11], e[12] = t[12], e[13] = t[13], e[14] = t[14], e[15] = t[15], e }, i.identity = function (t) { return t[0] = 1, t[1] = 0, t[2] = 0, t[3] = 0, t[4] = 0, t[5] = 1, t[6] = 0, t[7] = 0, t[8] = 0, t[9] = 0, t[10] = 1, t[11] = 0, t[12] = 0, t[13] = 0, t[14] = 0, t[15] = 1, t }, i.transpose = function (t, e) { if (!e || t == e) { var n = t[1], i = t[2], r = t[3], a = t[6], s = t[7], o = t[11]; return t[1] = t[4], t[2] = t[8], t[3] = t[12], t[4] = n, t[6] = t[9], t[7] = t[13], t[8] = i, t[9] = a, t[11] = t[14], t[12] = r, t[13] = s, t[14] = o, t } return e[0] = t[0], e[1] = t[4], e[2] = t[8], e[3] = t[12], e[4] = t[1], e[5] = t[5], e[6] = t[9], e[7] = t[13], e[8] = t[2], e[9] = t[6], e[10] = t[10], e[11] = t[14], e[12] = t[3], e[13] = t[7], e[14] = t[11], e[15] = t[15], e }, i.determinant = function (t) { var e = t[0], n = t[1], i = t[2], r = t[3], a = t[4], s = t[5], o = t[6], h = t[7], c = t[8], l = t[9], u = t[10], f = t[11], d = t[12], m = t[13], p = t[14]; return t = t[15], d * l * o * r - c * m * o * r - d * s * u * r + a * m * u * r + c * s * p * r - a * l * p * r - d * l * i * h + c * m * i * h + d * n * u * h - e * m * u * h - c * n * p * h + e * l * p * h + d * s * i * f - a * m * i * f - d * n * o * f + e * m * o * f + a * n * p * f - e * s * p * f - c * s * i * t + a * l * i * t + c * n * o * t - e * l * o * t - a * n * u * t + e * s * u * t }, i.inverse = function (t, e) { e || (e = t); var n = t[0], i = t[1], r = t[2], a = t[3], s = t[4], o = t[5], h = t[6], c = t[7], l = t[8], u = t[9], f = t[10], d = t[11], m = t[12], p = t[13], g = t[14], v = t[15], w = n * o - i * s, y = n * h - r * s, b = n * c - a * s, _ = i * h - r * o, x = i * c - a * o, C = r * c - a * h, A = l * p - u * m, T = l * g - f * m, E = l * v - d * m, k = u * g - f * p, R = u * v - d * p, I = f * v - d * g, D = 1 / (w * I - y * R + b * k + _ * E - x * T + C * A); return e[0] = (o * I - h * R + c * k) * D, e[1] = (-i * I + r * R - a * k) * D, e[2] = (p * C - g * x + v * _) * D, e[3] = (-u * C + f * x - d * _) * D, e[4] = (-s * I + h * E - c * T) * D, e[5] = (n * I - r * E + a * T) * D, e[6] = (-m * C + g * b - v * y) * D, e[7] = (l * C - f * b + d * y) * D, e[8] = (s * R - o * E + c * A) * D, e[9] = (-n * R + i * E - a * A) * D, e[10] = (m * x - p * b + v * w) * D, e[11] = (-l * x + u * b - d * w) * D, e[12] = (-s * k + o * T - h * A) * D, e[13] = (n * k - i * T + r * A) * D, e[14] = (-m * _ + p * y - g * w) * D, e[15] = (l * _ - u * y + f * w) * D, e }, i.toRotationMat = function (t, e) { return e || (e = i.create()), e[0] = t[0], e[1] = t[1], e[2] = t[2], e[3] = t[3], e[4] = t[4], e[5] = t[5], e[6] = t[6], e[7] = t[7], e[8] = t[8], e[9] = t[9], e[10] = t[10], e[11] = t[11], e[12] = 0, e[13] = 0, e[14] = 0, e[15] = 1, e }, i.toMat3 = function (t, e) { return e || (e = n.create()), e[0] = t[0], e[1] = t[1], e[2] = t[2], e[3] = t[4], e[4] = t[5], e[5] = t[6], e[6] = t[8], e[7] = t[9], e[8] = t[10], e }, i.toInverseMat3 = function (t, e) { var i = t[0], r = t[1], a = t[2], s = t[4], o = t[5], h = t[6], c = t[8], l = t[9], u = t[10], f = u * o - h * l, d = -u * s + h * c, m = l * s - o * c, p = i * f + r * d + a * m; return p ? (p = 1 / p, e || (e = n.create()), e[0] = f * p, e[1] = (-u * r + a * l) * p, e[2] = (h * r - a * o) * p, e[3] = d * p, e[4] = (u * i - a * c) * p, e[5] = (-h * i + a * s) * p, e[6] = m * p, e[7] = (-l * i + r * c) * p, e[8] = (o * i - r * s) * p, e) : null }, i.multiply = function (t, e, n) { n || (n = t); var i = t[0], r = t[1], a = t[2], s = t[3], o = t[4], h = t[5], c = t[6], l = t[7], u = t[8], f = t[9], d = t[10], m = t[11], p = t[12], g = t[13], v = t[14]; t = t[15]; var w = e[0], y = e[1], b = e[2], _ = e[3], x = e[4], C = e[5], A = e[6], T = e[7], E = e[8], k = e[9], R = e[10], I = e[11], D = e[12], X = e[13], M = e[14]; return e = e[15], n[0] = w * i + y * o + b * u + _ * p, n[1] = w * r + y * h + b * f + _ * g, n[2] = w * a + y * c + b * d + _ * v, n[3] = w * s + y * l + b * m + _ * t, n[4] = x * i + C * o + A * u + T * p, n[5] = x * r + C * h + A * f + T * g, n[6] = x * a + C * c + A * d + T * v, n[7] = x * s + C * l + A * m + T * t, n[8] = E * i + k * o + R * u + I * p, n[9] = E * r + k * h + R * f + I * g, n[10] = E * a + k * c + R * d + I * v, n[11] = E * s + k * l + R * m + I * t, n[12] = D * i + X * o + M * u + e * p, n[13] = D * r + X * h + M * f + e * g, n[14] = D * a + X * c + M * d + e * v, n[15] = D * s + X * l + M * m + e * t, n }, i.multiplyVec3 = function (t, e, n) { n || (n = e); var i = e[0], r = e[1]; return e = e[2], n[0] = t[0] * i + t[4] * r + t[8] * e + t[12], n[1] = t[1] * i + t[5] * r + t[9] * e + t[13], n[2] = t[2] * i + t[6] * r + t[10] * e + t[14], n }, i.multiplyVec4 = function (t, e, n) { n || (n = e); var i = e[0], r = e[1], a = e[2]; return e = e[3], n[0] = t[0] * i + t[4] * r + t[8] * a + t[12] * e, n[1] = t[1] * i + t[5] * r + t[9] * a + t[13] * e, n[2] = t[2] * i + t[6] * r + t[10] * a + t[14] * e, n[3] = t[3] * i + t[7] * r + t[11] * a + t[15] * e, n }, i.translate = function (t, e, n) { var i = e[0], r = e[1]; if (e = e[2], !n || t == n) return t[12] = t[0] * i + t[4] * r + t[8] * e + t[12], t[13] = t[1] * i + t[5] * r + t[9] * e + t[13], t[14] = t[2] * i + t[6] * r + t[10] * e + t[14], t[15] = t[3] * i + t[7] * r + t[11] * e + t[15], t; var a = t[0], s = t[1], o = t[2], h = t[3], c = t[4], l = t[5], u = t[6], f = t[7], d = t[8], m = t[9], p = t[10], g = t[11]; return n[0] = a, n[1] = s, n[2] = o, n[3] = h, n[4] = c, n[5] = l, n[6] = u, n[7] = f, n[8] = d, n[9] = m, n[10] = p, n[11] = g, n[12] = a * i + c * r + d * e + t[12], n[13] = s * i + l * r + m * e + t[13], n[14] = o * i + u * r + p * e + t[14], n[15] = h * i + f * r + g * e + t[15], n }, i.scale = function (t, e, n) { var i = e[0], r = e[1]; return e = e[2], n && t != n ? (n[0] = t[0] * i, n[1] = t[1] * i, n[2] = t[2] * i, n[3] = t[3] * i, n[4] = t[4] * r, n[5] = t[5] * r, n[6] = t[6] * r, n[7] = t[7] * r, n[8] = t[8] * e, n[9] = t[9] * e, n[10] = t[10] * e, n[11] = t[11] * e, n[12] = t[12], n[13] = t[13], n[14] = t[14], n[15] = t[15], n) : (t[0] *= i, t[1] *= i, t[2] *= i, t[3] *= i, t[4] *= r, t[5] *= r, t[6] *= r, t[7] *= r, t[8] *= e, t[9] *= e, t[10] *= e, t[11] *= e, t) }, i.rotate = function (t, e, n, i) { var r = n[0], a = n[1]; n = n[2]; var s = Math.sqrt(r * r + a * a + n * n); if (!s) return null; 1 != s && (s = 1 / s, r *= s, a *= s, n *= s); var o = Math.sin(e), h = Math.cos(e), c = 1 - h; e = t[0], s = t[1]; var l = t[2], u = t[3], f = t[4], d = t[5], m = t[6], p = t[7], g = t[8], v = t[9], w = t[10], y = t[11], b = r * r * c + h, _ = a * r * c + n * o, x = n * r * c - a * o, C = r * a * c - n * o, A = a * a * c + h, T = n * a * c + r * o, E = r * n * c + a * o; return r = a * n * c - r * o, a = n * n * c + h, i ? t != i && (i[12] = t[12], i[13] = t[13], i[14] = t[14], i[15] = t[15]) : i = t, i[0] = e * b + f * _ + g * x, i[1] = s * b + d * _ + v * x, i[2] = l * b + m * _ + w * x, i[3] = u * b + p * _ + y * x, i[4] = e * C + f * A + g * T, i[5] = s * C + d * A + v * T, i[6] = l * C + m * A + w * T, i[7] = u * C + p * A + y * T, i[8] = e * E + f * r + g * a, i[9] = s * E + d * r + v * a, i[10] = l * E + m * r + w * a, i[11] = u * E + p * r + y * a, i }, i.rotateX = function (t, e, n) { var i = Math.sin(e); e = Math.cos(e); var r = t[4], a = t[5], s = t[6], o = t[7], h = t[8], c = t[9], l = t[10], u = t[11]; return n ? t != n && (n[0] = t[0], n[1] = t[1], n[2] = t[2], n[3] = t[3], n[12] = t[12], n[13] = t[13], n[14] = t[14], n[15] = t[15]) : n = t, n[4] = r * e + h * i, n[5] = a * e + c * i, n[6] = s * e + l * i, n[7] = o * e + u * i, n[8] = r * -i + h * e, n[9] = a * -i + c * e, n[10] = s * -i + l * e, n[11] = o * -i + u * e, n }, i.rotateY = function (t, e, n) { var i = Math.sin(e); e = Math.cos(e); var r = t[0], a = t[1], s = t[2], o = t[3], h = t[8], c = t[9], l = t[10], u = t[11]; return n ? t != n && (n[4] = t[4], n[5] = t[5], n[6] = t[6], n[7] = t[7], n[12] = t[12], n[13] = t[13], n[14] = t[14], n[15] = t[15]) : n = t, n[0] = r * e + h * -i, n[1] = a * e + c * -i, n[2] = s * e + l * -i, n[3] = o * e + u * -i, n[8] = r * i + h * e, n[9] = a * i + c * e, n[10] = s * i + l * e, n[11] = o * i + u * e, n }, i.rotateZ = function (t, e, n) { var i = Math.sin(e); e = Math.cos(e); var r = t[0], a = t[1], s = t[2], o = t[3], h = t[4], c = t[5], l = t[6], u = t[7]; return n ? t != n && (n[8] = t[8], n[9] = t[9], n[10] = t[10], n[11] = t[11], n[12] = t[12], n[13] = t[13], n[14] = t[14], n[15] = t[15]) : n = t, n[0] = r * e + h * i, n[1] = a * e + c * i, n[2] = s * e + l * i, n[3] = o * e + u * i, n[4] = r * -i + h * e, n[5] = a * -i + c * e, n[6] = s * -i + l * e, n[7] = o * -i + u * e, n }, i.frustum = function (t, e, n, r, a, s, o) { o || (o = i.create()); var h = e - t, c = r - n, l = s - a; return o[0] = 2 * a / h, o[1] = 0, o[2] = 0, o[3] = 0, o[4] = 0, o[5] = 2 * a / c, o[6] = 0, o[7] = 0, o[8] = (e + t) / h, o[9] = (r + n) / c, o[10] = -(s + a) / l, o[11] = -1, o[12] = 0, o[13] = 0, o[14] = -(s * a * 2) / l, o[15] = 0, o }, i.perspective = function (t, e, n, r, a) { return t = n * Math.tan(t * Math.PI / 360), e = t * e, i.frustum(-e, e, -t, t, n, r, a) }, i.ortho = function (t, e, n, r, a, s, o) { o || (o = i.create()); var h = e - t, c = r - n, l = s - a; return o[0] = 2 / h, o[1] = 0, o[2] = 0, o[3] = 0, o[4] = 0, o[5] = 2 / c, o[6] = 0, o[7] = 0, o[8] = 0, o[9] = 0, o[10] = -2 / l, o[11] = 0, o[12] = -(t + e) / h, o[13] = -(r + n) / c, o[14] = -(s + a) / l, o[15] = 1, o }, i.lookAt = function (t, e, n, r) { r || (r = i.create()); var a = t[0], s = t[1]; t = t[2]; var o = n[0], h = n[1], c = n[2]; n = e[1]; var l = e[2]; if (a == e[0] && s == n && t == l) return i.identity(r); var u, f, d, m; return n = a - e[0], l = s - e[1], e = t - e[2], m = 1 / Math.sqrt(n * n + l * l + e * e), n *= m, l *= m, e *= m, u = h * e - c * l, c = c * n - o * e, o = o * l - h * n, (m = Math.sqrt(u * u + c * c + o * o)) ? (m = 1 / m, u *= m, c *= m, o *= m) : o = c = u = 0, h = l * o - e * c, f = e * u - n * o, d = n * c - l * u, (m = Math.sqrt(h * h + f * f + d * d)) ? (m = 1 / m, h *= m, f *= m, d *= m) : d = f = h = 0, r[0] = u, r[1] = h, r[2] = n, r[3] = 0, r[4] = c, r[5] = f, r[6] = l, r[7] = 0, r[8] = o, r[9] = d, r[10] = e, r[11] = 0, r[12] = -(u * a + c * s + o * t), r[13] = -(h * a + f * s + d * t), r[14] = -(n * a + l * s + e * t), r[15] = 1, r }, i.str = function (t) { return "[" + t[0] + ", " + t[1] + ", " + t[2] + ", " + t[3] + ", " + t[4] + ", " + t[5] + ", " + t[6] + ", " + t[7] + ", " + t[8] + ", " + t[9] + ", " + t[10] + ", " + t[11] + ", " + t[12] + ", " + t[13] + ", " + t[14] + ", " + t[15] + "]" }; var r = {}; r.create = function (e) { var n = new t(4); return e && (n[0] = e[0], n[1] = e[1], n[2] = e[2], n[3] = e[3]), n }, r.set = function (t, e) { return e[0] = t[0], e[1] = t[1], e[2] = t[2], e[3] = t[3], e }, r.calculateW = function (t, e) { var n = t[0], i = t[1], r = t[2]; return e && t != e ? (e[0] = n, e[1] = i, e[2] = r, e[3] = -Math.sqrt(Math.abs(1 - n * n - i * i - r * r)), e) : (t[3] = -Math.sqrt(Math.abs(1 - n * n - i * i - r * r)), t) }, r.inverse = function (t, e) { return e && t != e ? (e[0] = -t[0], e[1] = -t[1], e[2] = -t[2], e[3] = t[3], e) : (t[0] *= 1, t[1] *= 1, t[2] *= 1, t) }, r.length = function (t) { var e = t[0], n = t[1], i = t[2]; return t = t[3], Math.sqrt(e * e + n * n + i * i + t * t) }, r.normalize = function (t, e) { e || (e = t); var n = t[0], i = t[1], r = t[2], a = t[3], s = Math.sqrt(n * n + i * i + r * r + a * a); return 0 == s ? (e[0] = 0, e[1] = 0, e[2] = 0, e[3] = 0, e) : (s = 1 / s, e[0] = n * s, e[1] = i * s, e[2] = r * s, e[3] = a * s, e) }, r.multiply = function (t, e, n) { n || (n = t); var i = t[0], r = t[1], a = t[2]; t = t[3]; var s = e[0], o = e[1], h = e[2]; return e = e[3], n[0] = i * e + t * s + r * h - a * o, n[1] = r * e + t * o + a * s - i * h, n[2] = a * e + t * h + i * o - r * s, n[3] = t * e - i * s - r * o - a * h, n }, r.multiplyVec3 = function (t, e, n) { n || (n = e); var i = e[0], r = e[1], a = e[2]; e = t[0]; var s = t[1], o = t[2]; t = t[3]; var h = t * i + s * a - o * r, c = t * r + o * i - e * a, l = t * a + e * r - s * i; return i = -e * i - s * r - o * a, n[0] = h * t + i * -e + c * -o - l * -s, n[1] = c * t + i * -s + l * -e - h * -o, n[2] = l * t + i * -o + h * -s - c * -e, n }, r.toMat3 = function (t, e) { e || (e = n.create()); var i = t[0], r = t[1], a = t[2], s = t[3], o = i + i, h = r + r, c = a + a, l = i * o, u = i * h; i *= c; var f = r * h; return r *= c, a *= c, o = s * o, h = s * h, s *= c, e[0] = 1 - (f + a), e[1] = u - s, e[2] = i + h, e[3] = u + s, e[4] = 1 - (l + a), e[5] = r - o, e[6] = i - h, e[7] = r + o, e[8] = 1 - (l + f), e }, r.toMat4 = function (t, e) { e || (e = i.create()); var n = t[0], r = t[1], a = t[2], s = t[3], o = n + n, h = r + r, c = a + a, l = n * o, u = n * h; n *= c; var f = r * h; return r *= c, a *= c, o = s * o, h = s * h, s *= c, e[0] = 1 - (f + a), e[1] = u - s, e[2] = n + h, e[3] = 0, e[4] = u + s, e[5] = 1 - (l + a), e[6] = r - o, e[7] = 0, e[8] = n - h, e[9] = r + o, e[10] = 1 - (l + f), e[11] = 0, e[12] = 0, e[13] = 0, e[14] = 0, e[15] = 1, e }, r.slerp = function (t, e, n, i) { i || (i = t); var r = n; return t[0] * e[0] + t[1] * e[1] + t[2] * e[2] + t[3] * e[3] < 0 && (r = -1 * n), i[0] = 1 - n * t[0] + r * e[0], i[1] = 1 - n * t[1] + r * e[1], i[2] = 1 - n * t[2] + r * e[2], i[3] = 1 - n * t[3] + r * e[3], i }, r.str = function (t) { return "[" + t[0] + ", " + t[1] + ", " + t[2] + ", " + t[3] + "]" }, this.mat4 = i, this.quat4 = r, this.vec3 = e } } }), t.Matrix2D = i.extend({ statics: { DEG_TO_RAD: .017453292519943295 }, ctor: function (t, e, n, i, r, a) { return this.a = null == t ? 1 : t, this.b = e || 0, this.c = n || 0, this.d = null == i ? 1 : i, this.tx = r || 0, this.ty = a || 0, this }, identity: function () { return this.a = this.d = 1, this.b = this.c = this.tx = this.ty = 0, this }, appendTransform: function (e, n, i, r, a, s, o, h, c, l, u) { if (a % 360) var f = a * t.Matrix2D.DEG_TO_RAD, d = Math.cos(f), m = Math.sin(f); else d = 1, m = 0; return s || o ? (s *= t.Matrix2D.DEG_TO_RAD, o *= t.Matrix2D.DEG_TO_RAD, this.append(Math.cos(o), Math.sin(o), -Math.sin(s), Math.cos(s), e, n), this.append(d * i, m * i, -m * r, d * r, 0, 0)) : this.append(d * i, m * i, -m * r, d * r, e, n), (h || c) && (this.tx -= h * this.a + c * this.c, this.ty -= h * this.b + c * this.d), l && (this.a *= -1, this.c *= -1), u && (this.b *= -1, this.d *= -1), this }, append: function (t, e, n, i, r, a) { var s = this.a, o = this.b, h = this.c, c = this.d; return this.a = t * s + e * h, this.b = t * o + e * c, this.c = n * s + i * h, this.d = n * o + i * c, this.tx = r * s + a * h + this.tx, this.ty = r * o + a * c + this.ty, this }, reinitialize: function (t, e, n, i, r, a, s, o, h) { return this.initialize(t, e, n, i, r, a), this.alpha = s || 1, this.shadow = o, this.compositeOperation = h, this }, initialize: function (t, e, n, i, r, a) { return null != t && (this.a = t), this.b = e || 0, this.c = n || 0, null != i && (this.d = i), this.tx = r || 0, this.ty = a || 0, this } }), t.UID = i.extend({ statics: { _nextID: 0, _nextCacheID: 1, get: function () { return this._nextID++ }, getCacheID: function () { return this._nextCacheID++ } } }), new e.Main
            }()
        }(Function("return this")());
    </script>
</body>
</html>
